#!/usr/bin/env node
// vim:syntax=javascript

var vock = require('..'),
    colors = require('colors'),
    argv = require('optimist')
        .usage('Usage:\n' +
               '   $0 create\n' +
               '   $0 connect {id}\n\n' +
               'Optional parameters:\n' +
               '   --server serveraddr:port')
        .alias('s', 'server')
        .alias('m', 'mute')
        .argv,
    cmd = argv._[0];

function getAddress(addr) {
  addr = addr.split(':', 2);

  return {
    host: addr[0] || '0.0.0.0',
    port: addr[1] || 44123
  };
};

var instance = vock.instance.create(argv),
    api = vock.api.create(getAddress(argv.s || 'vock.indutny.com:43210'),
                          instance);

if (cmd === 'create') {
  api.create(function(err, id) {
    if (err) throw err;

    console.log('Room created!'.green);
    console.log('Run to connect to this session:');
    console.log('  ' + process.argv[0] + ' connect ' + id);
    console.log('Waiting for opponent...');

    api.watch(id, function(err, addrs) {
      if (err) throw err;

      var target = addrs[addrs.length - 1];
      console.log('Opponent appeared: '.green + '%s %d',
                  target.address,
                  target.port);
      instance.connect(target.port, target.address, function() {
        console.log('Connected!'.green);
      });
    });
  });
  return;
} else if (cmd === 'connect' && argv._[1]) {
  api.connect(argv._[1], function(err, addrs) {
    if (err) throw err;

    var target = addrs[0];
    console.log('Got opponent\'s address: '.green + '%s:%d',
                target.address,
                target.port);
    instance.connect(target.port, target.address, function() {
      console.log('Connected!'.green);
    });
  });
  return;
}

require('optimist').showHelp()
process.exit(0);
